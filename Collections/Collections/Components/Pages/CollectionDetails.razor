@page "/collection-details/{id:int}"
@using Components.TestData
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> _UserManager
@inject RoleManager<IdentityRole> _RoleManager
@inject SignInManager<ApplicationUser> _SignInManager
@inject AuthenticationStateProvider _AuthenticationStateProvider
@inject NavigationManager _navigationManager
@inject IDbContextFactory<ApplicationDbContext> _contextFactory
@inject IConfiguration _configuration
@inject IBlobService _blobService
@inject IFileTransferManager _fileTransferManager

@rendermode InteractiveServer

<PageTitle>Collection details</PageTitle>
<AuthorizeView>
    @if (collection is null)
    {
        <p><em>Loading...</em></p>
    }
    else
    {
        <div class="container-xxl py-3">
            <div class="pb-1">
                <h1 class="display-6">
                    @collection.Name
                </h1>
                <h3>
                    <span class="badge border bg-light text-dark">
                        <i class="text-success bi bi-arrow-right-circle"></i>
                        @collection.Theme!.Name
                    </span>
                </h3>
                <div class="card mb-3 w-100" style="box-shadow: rgba(0,0,0,0.19) 0px 5px 10px, rgba(0,0,0,0.23) 0px 3px 3px;">
                    <div class="row g-0">
                        <div class="col-md">
                            <h5 class="card-header">Description:</h5>
                            <div class="card-body">
                                <div class="px-5 py-2">
                                    @((MarkupString)@collection.Description)
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            @if (!(newItemRequested || editItemRequested || deleteItemRequested))
            {
                <div class="pb-2 d-flex justify-content-start m-0 row col-md
                        row-cols-md-auto gap-1">
                    <button @onclick="ToggleNewItemRequestStatus"
                            class="btn btn-outline-success btn-sm text-nowrap"
                            asp-formaction="Block" name="Block"
                            type="submit" value="true" style="box-shadow: rgba(0,0,0,0.19) 0px 5px 10px, rgba(0,0,0,0.23) 0px 3px 3px;">
                        <i class="bi bi-plus-square"></i> New Item
                    </button>
                    <button @onclick="ToggleEditCollectionRequestStatus"
                            class="btn btn-outline-secondary btn-sm text-nowrap"
                            asp-formaction="Block" name="Block"
                            type="submit" value="true" style="box-shadow: rgba(0,0,0,0.19) 0px 5px 10px, rgba(0,0,0,0.23) 0px 3px 3px;">
                        <i class="bi bi-pencil"></i> Edit Collection
                    </button>
                    <button @onclick="ToggleDeleteCollectionRequestStatus"
                            class="btn btn-outline-danger btn-sm text-nowrap"
                            asp-formaction="Block" name="Block"
                            type="submit" value="true" style="box-shadow: rgba(0,0,0,0.19) 0px 5px 10px, rgba(0,0,0,0.23) 0px 3px 3px;">
                        <i class="bi bi-trash3-fill"></i> Delete Collection
                    </button>
                </div>
            }
            @if (newItemRequested && !editItemRequested && !deleteItemRequested)
            {
                <div class="d-flex justify-content-center py-2">
                    <div class="card w-75 mb-3" style=" box-shadow: rgba(0,0,0,0.25) 0px 20px 30px, rgba(0,0,0,0.32) 0px 12px 12px;">
                        <div class="row g-0">
                            @if (string.IsNullOrWhiteSpace(TempImg))
                            {
                                <div class="col-md-4">
                                    <canvas class="img-fluid h-100 rounded-start" style="background-color: lightgray; object-fit:cover;" />
                                </div>
                            }
                            else
                            {
                                <div class="col-md-4">
                                    <img src="@TempImg" class="img-fluid h-100 rounded-start" style="background-color: lightgray;  object-fit:cover;" alt="...">
                                </div>
                            }
                            <div class="col-md-8">
                                <h5 class="card-header">Create New Item</h5>
                                <EditForm Context="formContext" Model="@ItemModel" OnValidSubmit="@SubmitNewItem" FormName="NewItemForm">
                                    <div class="card-body">
                                        <div class="px-5 py-2">
                                            <DataAnnotationsValidator />
                                            <ValidationSummary />
                                            @* Identifier: *@
                                            <InputText @bind-Value="ItemModel!.Name" type="text" class="input-group-text input-group-lg w-100 my-2" placeholder="Item Name..." />
                                            @* <InputText @bind-Value="TempImg" class="input-group-text input-group-lg w-100 my-2" placeholder="Link to item photo (optional)..." /> *@
                                            @if (!string.IsNullOrWhiteSpace(FileError))
                                            {
                                                <div class="alert alert-warning d-flex align-items-center" role="alert">
                                                    <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Warning:"><use xlink:href="#exclamation-triangle-fill" /></svg>
                                                    <div>
                                                        @FileError
                                                    </div>
                                                </div>
                                            }
                                            @if (ItemModel is not null)
                                            {
                                                <InputFile OnChange="UploadFile" class="form-control my-2" type="file" id="formFile" accept=".png,.jpg,.jpeg,.tiff" />
                                            }
                                        </div>
                                    </div>
                                    <div class="pb-2 pe-3 mx-0 d-flex justify-content-end row col-md
                                 row-cols-md-auto gap-1 card-footer">
                                        <button @onclick="ToggleNewItemRequestStatus"
                                                class="btn btn-outline-secondary text-nowrap"
                                                asp-formaction="Block" name="Block"
                                                type="button" value="true" style="box-shadow: rgba(0,0,0,0.19) 0px 5px 10px, rgba(0,0,0,0.23) 0px 3px 3px;">
                                            <i class="bi bi-plus-square"></i> Cancel
                                        </button>
                                        <button class="btn btn-outline-success text-nowrap"
                                                type="submit" value="true" style="box-shadow: rgba(0,0,0,0.19) 0px 5px 10px, rgba(0,0,0,0.23) 0px 3px 3px;">
                                            <i class="bi bi-plus-square"></i> Create
                                        </button>
                                    </div>
                                </EditForm>
                            </div>
                        </div>
                    </div>
                </div>
            }
            @if (editItemRequested && !newItemRequested && !deleteItemRequested)
            {
                <div class="d-flex justify-content-center py-2">
                    <div class="card w-75 mb-3" style=" box-shadow: rgba(0,0,0,0.25) 0px 20px 30px, rgba(0,0,0,0.32) 0px 12px 12px;">
                        <div class="row g-0">
                            @if (string.IsNullOrWhiteSpace(TempImg))
                            {
                                <div class="col-md-4">
                                    <canvas class="img-fluid h-100 rounded-start" style="background-color: lightgray; object-fit:cover;" />
                                </div>
                            }
                            else
                            {
                                <div class="col-md-4">
                                    <img src="@TempImg" class="img-fluid h-100 rounded-start" style="background-color: lightgray;  object-fit:cover;" alt="...">
                                </div>
                            }
                            <div class="col-md-8">
                                <h5 class="card-header">Edit Collection: @CollectionModel!.Name</h5>
                                @if (!collectionChangeRequestValid)
                                {
                                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                                        <div>
                                            <strong>Holy guacamole!</strong>There are no changes pending to apply
                                        </div>
                                        <div>
                                            <button @onclick="ResetCollectionChangeRequestValidStatus" type="button" class="btn-close " data-dismiss="alert" aria-label="Close">
                                            </button>
                                        </div>
                                    </div>
                                }
                                <EditForm Context="formContext" Model="@CollectionModel" OnSubmit="@SubmitEditCollection" FormName="EditCollectionForm">
                                    <div class="card-body">
                                        <p class="card-text"><small class="text-muted">Created @CollectionModel!.CreationDateTime.ToLocalTime()</small></p>
                                        <div class="px-5 py-2">
                                            @if (!addNewThemeRequested)
                                            {
                                                <DataAnnotationsValidator />
                                                <ValidationSummary />
                                                @* Identifier: *@
                                                <InputText @bind-Value="CollectionModel!.Name" type="text" class="input-group-text input-group-lg w-100 my-2" placeholder="Collection New Name..." />
                                                <InputTextArea @bind-Value="CollectionModel.Description" type="text" class="text-start input-group-text input-group-lg w-100 my-2" placeholder="Collection New Description" />
                                               
                                                @* <InputText @bind-Value="TempImg" class="input-group-text input-group-lg w-100 my-2" placeholder="Link to collection new photo (optional)..." /> *@
                                                @if (!string.IsNullOrWhiteSpace(FileError2))
                                                {
                                                    <div class="alert alert-warning d-flex align-items-center" role="alert">
                                                        <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Warning:"><use xlink:href="#exclamation-triangle-fill" /></svg>
                                                        <div>
                                                            @FileError2
                                                        </div>
                                                    </div>
                                                }
                                                @if (ItemModel is not null)
                                                {
                                                    <InputFile OnChange="UploadFile2" class="form-control my-2" type="file" id="formFile" accept=".png,.jpg,.jpeg,.tiff" />
                                                }
                                                <div class="row row-cols-1 row-cols-md-3">
                                                    <div class="flex-fill pe-md-0 mx-0">
                                                        <input @bind="ThemeNameChoosen" class="form-control" list="datalistOptions" id="exampleDataList" placeholder="Theme...">
                                                        <datalist id="datalistOptions">
                                                            @foreach (var t in Themes)
                                                            {
                                                                <option value="@t.Name" />
                                                            }
                                                        </datalist>
                                                    </div>
                                                    <div class="mx-0 my-2 ps-md-2 my-md-0">
                                                        <button @onclick="RequestNewTheme"
                                                                class="btn w-100 btn-outline-secondary text-nowrap"
                                                                asp-formaction="Block" name="Block"
                                                                type="button" value="true" style="box-shadow: rgba(0,0,0,0.19) 0px 5px 10px, rgba(0,0,0,0.23) 0px 3px 3px;">
                                                            <i class="bi bi-plus-square"></i> Add Theme
                                                        </button>
                                                    </div>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="card">
                                                    <div class="card-header">
                                                        New category
                                                    </div>
                                                    <div class="card-body">
                                                        @if (!newThemeAddFinishedSuccessfully)
                                                        {
                                                            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                                                                <div>
                                                                    <strong>Holy guacamole!</strong> This category already exists
                                                                </div>
                                                                <div>
                                                                    <button type="button" class="btn-close " data-dismiss="alert" aria-label="Close">
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        }
                                                        <input type="text" @bind="NewTheme" class="form-control mt-3" placeholder="Enter new collection category...">
                                                        <div class="d-flex justify-content-end me-0 ms-0 mt-3 mb-0 row col-md
                                 row-cols-md-auto gap-1">
                                                            <button @onclick="RequestNewTheme"
                                                                    class="btn btn-outline-secondary text-nowrap"
                                                                    asp-formaction="Block" name="Block"
                                                                    type="button" value="true" style="box-shadow: rgba(0,0,0,0.19) 0px 5px 10px, rgba(0,0,0,0.23) 0px 3px 3px;">
                                                                <i class="bi bi-plus-square"></i> Cancel
                                                            </button>
                                                            <button @onclick="SubmitNewTheme"
                                                                    class="btn btn-outline-success text-nowrap"
                                                                    type="button" value="true" style="box-shadow: rgba(0,0,0,0.19) 0px 5px 10px, rgba(0,0,0,0.23) 0px 3px 3px;">
                                                                <i class="bi bi-plus-square"></i> Add
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                    <div class="pb-2 pe-3 mx-0 d-flex justify-content-end row col-md
                                 row-cols-md-auto gap-1 card-footer">
                                        <button @onclick="ToggleEditCollectionRequestStatus"
                                                class="btn btn-outline-secondary text-nowrap"
                                                asp-formaction="Block" name="Block"
                                                type="button" value="true" style="box-shadow: rgba(0,0,0,0.19) 0px 5px 10px, rgba(0,0,0,0.23) 0px 3px 3px;">
                                            <i class="bi bi-plus-square"></i> Cancel
                                        </button>
                                        <button class="btn btn-outline-success text-nowrap"
                                                type="submit" value="true" style="box-shadow: rgba(0,0,0,0.19) 0px 5px 10px, rgba(0,0,0,0.23) 0px 3px 3px;">
                                            <i class="bi bi-plus-square"></i> Update
                                        </button>
                                    </div>
                                </EditForm>
                            </div>
                        </div>
                    </div>
                </div>
            }
            @if (deleteItemRequested && !newItemRequested && !editItemRequested)
            {
                <div class="d-flex justify-content-center py-2">
                    <div class="card w-75 mb-3" style=" box-shadow: rgba(0,0,0,0.25) 0px 20px 30px, rgba(0,0,0,0.32) 0px 12px 12px;">
                        <div class="row g-0">
                            @if (string.IsNullOrWhiteSpace(collection.ImageLink))
                            {
                                <div class="col-md-4">
                                    <canvas class="img-fluid h-100 rounded-start" style="background-color: lightgray; object-fit:cover;" />
                                </div>
                            }
                            else
                            {
                                <div class="col-md-4">
                                    <img src="@collection.ImageLink" class="img-fluid h-100 rounded-start" style="background-color: lightgray;  object-fit:cover;" alt="...">
                                </div>
                            }
                            <div class="col-md-8">
                                <h5 class="card-header">Delete Collection</h5>
                                <div class="card-body">
                                    <p class="card-text">@collection.Name</p>
                                    <p class="card-text"><small class="text-muted">Created @collection.CreationDateTime.ToLocalTime()</small></p>
                                    <div class="px-5 py-2">
                                        <p>This action can not be undone</p>
                                        <p>Are you sure you want to delete the collection?</p>
                                    </div>
                                </div>
                                <div class="pb-2 pe-3 mx-0 d-flex justify-content-end row col-md
                                 row-cols-md-auto gap-1 card-footer">
                                    <button @onclick="ToggleDeleteCollectionRequestStatus"
                                            class="btn btn-outline-secondary text-nowrap"
                                            asp-formaction="Block" name="Block"
                                            type="button" value="true" style="box-shadow: rgba(0,0,0,0.19) 0px 5px 10px, rgba(0,0,0,0.23) 0px 3px 3px;">
                                        <i class="bi bi-plus-square"></i> Cancel
                                    </button>
                                    <button @onclick="@SubmitDeleteCollection"
                                            class="btn btn-outline-danger text-nowrap"
                                            type="submit" value="true" style="box-shadow: rgba(0,0,0,0.19) 0px 5px 10px, rgba(0,0,0,0.23) 0px 3px 3px;">
                                        <i class="bi bi-plus-square"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
            <div class="justify-content-between my-3">
                <div class="row row-cols-1 row-cols-sm-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-3
                            justify-content-center justify-content-md-start">
                    @if (itemsBunch is not null)
                    {
                        @foreach (Item item in itemsBunch)
                        {
                            <div class="col" style="min-width: 100px;">
                                <ItemCard Item="item" Collection="collection" />
                            </div>
                        }
                    }
                    else
                    {
                        for (int i = 0; i < 10; i++)
                        {
                            <div class="col">
                                <ItemCard />
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    }
</AuthorizeView>
